var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};var e=function(){return e=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},e.apply(this,arguments)};function r(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}c((n=n.apply(t,e||[])).next())}))}function n(t,e){var r,n,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}"function"==typeof SuppressedError&&SuppressedError;var o=function(){function t(){this._evt={}}return t.prototype.$on=function(t,e){this._evt[t]=this._evt[t]||[],this._evt[t].push(e)},t.prototype.$emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var n=this._evt[t]||[];n.length&&n.forEach((function(t){t.apply(null,e)}))},t.prototype.$off=function(t,e){var r=this._evt[t]||[];if(e){var n=r.findIndex(e);r.splice(n,1)}else this._evt[t]=[]},t.prototype.$remove=function(){this._evt={}},t}(),i={getTypeString:function(t){return Object.prototype.toString.call(t).toLowerCase()},isString:function(t){return"[object string]"===this.getTypeString(t)},isJsonString:function(t){try{return"object"==typeof JSON.parse(t)}catch(t){return!1}},isNumber:function(t){return"[object number]"===this.getTypeString(t)},isBoolean:function(t){return"[object boolean]"===this.getTypeString(t)},isArray:function(t){return"[object array]"===this.getTypeString(t)},isNull:function(t){return"[object null]"===this.getTypeString(t)},isUndefined:function(t){return"[object undefined]"===this.getTypeString(t)},isFunction:function(t){var e=this.getTypeString(t);return"[object function]"===e||"[object asyncfunction]"===e||"[object promise]"===e},isObject:function(t){return"[object object]"===this.getTypeString(t)},isError:function(t){var e=this.getTypeString(t);return"[object error]"===e||"[object errorevent]"===e},isRegexp:function(t){return"[object regexp]"===this.getTypeString(t)}},a=navigator.userAgent.toLowerCase();var s="load",c="windowError",u="hashchange",p="historyStatechange",f="popstate",l="promiseError",h=function(t){var e=!1;function r(t,n){if(!t)return!1;for(var o=["head","meta","script","style","title"],i=[].slice.call(t.children||[]).filter((function(t){return o.indexOf(t.tagName.toLowerCase())<0})),a=0;a<i.length;a++){var s=i[a],c=s.getBoundingClientRect(),u=c.width,p=c.height;if((n=u>0&&p>0?n+1:n)>0)return e=!0;1===s.nodeType&&o.indexOf(s.tagName.toLowerCase())<0&&r(s,n)}return e}t.$on(s,(function(){var e=t.options,n=e.domId,o=e.whiteTime;setTimeout((function(){r(document.querySelector("#".concat(n))||document.querySelector(".".concat(n)),0)||t.report({type:"blankScreen"})}),1e3*o)}))},d=function(t){t.$on(c,(function(e){(e.target||{}).tagName||t.reportError(e)})),t.$on(l,(function(e){i.isError(e.reason)&&t.reportError(e.reason)})),t.$on(s,(function(){window.Vue&&t.captureVueError()}))},y=function(){return(new Date).getTime()},v=function(t){var e=(window.performance||window.webkitPerformance||window.msPerformance||window.mozPerformance).timing||{};r(void 0,void 0,void 0,(function(){var r,o,i,a,s,c;return n(this,(function(n){switch(n.label){case 0:return r=t.options,o=r.client,i=r.ua,a=r.system,s=r.device,c={type:"openPage",client:o,ua:i,system:a,device:s,occurTime:e.fetchStart||y()},[4,t.report(c)];case 1:return n.sent(),[2]}}))}))},g=function(t){var e=history[t];history[t]=function(){var t=[].slice.call(arguments),r=new CustomEvent(p),n=e.apply(this,t);return window.dispatchEvent(r),n}},w=function(t){var e=t.options.spa,r=void 0===e||e,n=function(){try{for(var t=0,e=[{reg:/edge\/([\d.]+)/,name:"Edge"},{reg:/rv:([\d.]+)\) like gecko/,name:"IE"},{reg:/msie ([\d.]+)/,name:"IE"},{reg:/firefox\/([\d.]+)/,name:"Firefox"},{reg:/chrome\/([\d.]+)/,name:"Chrome"},{reg:/opera.([\d.]+)/,name:"Opera"},{reg:/version\/([\d.]+).*safari/,name:"Safari"},{reg:/AppleWebKit\/([\d.]+).*mobile.*/i,name:"webkit"}];t<e.length;t++){var r=e[t],n=r.reg,o=r.name,i=a.match(n);if(i&&i[1])return"".concat(o," ").concat(i[1])}}catch(t){console.log(t)}return"unknow"}().toLowerCase(),o=window.history.pushState?"history":"hash";t.$on(s,(function(){("chrome"!==n&&"safari"!==n||"history"!==o)&&t.report({type:"pageView"})})),r&&("hash"===o&&t.$on(u,(function(){t.report({type:"pageView"})})),"history"===o&&t.$on(f,(function(){t.report({type:"pageView"})})),g("pushState"),g("replaceState"),t.$on(p,(function(){t.report({type:"pageView"})})))},m=function(t){"undefined"!=typeof window&&function(t){var r=window.fetch;window.fetch=function(){var n=Array.from(arguments),o=n&&n[0]&&n[0].split("?")||[],i=y(),a={requestUrl:o[0]||"",requestUrlParams:o[1]||"",requestType:((n[1]||{}).method||"get").toUpperCase()};return r.apply(this,n).then((function(r){try{if(r){var n=r.clone();n.status,n.text().then((function(r){(a=e(e({},a),{duration:y()-i,requestId:n.headers.get("requestid")||"",requestCode:n.status,type:"apiRequest"})).requestUrl&&t.report(a)}))}}catch(e){t.reportError(e)}})).catch((function(e){t.reportError(e)}))}}(t)},b=function(t){"undefined"!=typeof window&&function(t){var e=window.XMLHttpRequest.prototype,r=e.open,n=e.setRequestHeader,o=e.send;e.open=function(t,e){this.__reqData__={method:t,url:e||"",start:y(),headers:{}};var n=Array.from(arguments);r.apply(this,n)},e.setRequestHeader=function(t,e){this.__reqData__&&(this.__reqData__.headers[t]=e);var r=Array.from(arguments);n.apply(this,r)},e.send=function(){var e=this.onreadystatechange||function(){};this.onreadystatechange=function(){var r,n,o=Array.from(arguments);if(e.apply(this,o),4===this.readyState&&this.__reqData__)try{var i=(r=this.getAllResponseHeaders().trim().split(/[\r\n]+/),n={},r.forEach((function(t){var e=t.split(": ");e.length&&(n[e[0]]=e[1])})),n||{}),a=this.__reqData__.url.split("?")||[],s={requestId:i.requestid||"",duration:y()-this.__reqData__.startTime,requestUrl:a[0]||"",requestUrlParams:a[1]||"",requestType:this.__reqData__.method.toUpperCase(),requestCode:this.status,type:"apiRequest"};if(!s.requestUrl)return;t.report(s)}catch(e){t.reportError(e)}};var r=Array.from(arguments);o.apply(this,r)}}(t)},_=function(t){t.$on(c,(function(e){(e.target||{}).tagName&&t.reportError(e)}))},E=function(t){var e=function(e){t.$emit(s,e)},r=function(e){t.$emit(c)},n=function(e){t.$emit(l)},o=function(){t.$emit(u)},i=function(){t.$emit(f)},a=function(){t.$emit(p)};window.addEventListener("load",e),window.addEventListener("error",r,!0),window.addEventListener("unhandledrejection",n),window.addEventListener("hashchange",o),window.addEventListener("popstate",i),window.addEventListener("historyStatechange",a),window.addEventListener("beforeunload",(function(){window.removeEventListener("load",e),window.removeEventListener("error",r,!0),window.removeEventListener("unhandledrejection",n),window.removeEventListener("hashchange",o),window.removeEventListener("popstate",i),window.removeEventListener("historyStatechange",a),t.$remove(),t.uninstall()}))};var S=function(o){function a(t){var e=o.call(this)||this;return e.startHooks=Array,e.options=t,e.beforeStart=null==t?void 0:t.beforeStart,e.beforeReport=null==t?void 0:t.beforeReport,e._isReady=!1,e._isCaptured=!1,e}return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}(a,o),a.prototype.start=function(){return r(this,void 0,void 0,(function(){var t,e,r;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,5,,6]),(null===(r=this.options)||void 0===r?void 0:r.projectId)?this.beforeStart?[4,this.beforeStart(this)]:[3,2]:(console.error("项目唯一标识未传！"),[2]);case 1:if("boolean"==typeof(t=n.sent())&&!t)return[2];n.label=2;case 2:return function(t){var e,r=t.options.plugins,n=void 0===r?[]:r;if(n.length){t.startHooks.push(E);var o=((e={}).openPage=v,e.pageView=w,e.blankScreen=h,e.sourceError=_,e.apiRequest=[m,b],e.jsError=d,e.performance=performance,e);n.forEach((function(e){var r=o[e];i.isArray(r)?t.startHooks=t.startHooks.concat(r):t.startHooks.push(r)}))}}(this),this.startHooks?[4,(o=this.startHooks,a=this,Promise.all(o.map((function(t){return t.call(null,a)}))))]:[3,4];case 3:n.sent(),n.label=4;case 4:return[3,6];case 5:return e=n.sent(),console.log(e),[3,6];case 6:return[2]}var o,a}))}))},a.prototype.report=function(t){try{if(!this._isReady)return void console.warn("项目未调用install方法，请先调用",t);e({},i.isObject(t)?t:{})}catch(t){console.log(t)}},a.prototype.reportError=function(t,o){return r(this,void 0,void 0,(function(){var r,a,s,c;return n(this,(function(n){switch(n.label){case 0:return i.isString(t)||i.isNumber(t)?[2]:(r=t.target||{},o&&!i.isObject(o)&&(o={}),r.tagName?(a=r.src||r.url||r.link||r.href,c={requestUrl:a&&a.split("?")[0],resourceType:r.tagName.toLowerCase()},[4,this.report(e(e({},c),{type:"sourceError"}))]):[3,2]);case 1:return n.sent(),[3,4];case 2:return"APIError"===t.name?[2]:(s=function(t,e){var r=!1;try{e||(r=!0),i.isArray(t)&&t.length&&e&&(r=t.some((function(t){if(i.isString(t)){var r=t.toLowerCase();return e.toLowerCase().indexOf(r)>-1}if(i.isRegexp(t))return t.test(e)})))}catch(t){console.error(t)}return r}(this.options.scriptErrorWhite||[],t.message),!t.message||s?[3,4]:(c={errorMessage:t.message,errorStack:t.stack},[4,this.report(e(e(e({},c),{type:"jsError"}),o))]));case 3:n.sent(),n.label=4;case 4:return[2]}}))}))},a.prototype.captureVueError=function(t){t=t||window.Vue;var e=this;if(t&&!this._isCaptured&&t.config){var r=t.config.errorHandler;t.config.errorHandler=function(t){console.error(t),e.reportError(t),r&&r.apply(this,[].slice.call(arguments))},this._isCaptured=!0}},a.prototype.install=function(t){this.options.plugins=t,this.start().catch((function(t){console.log(t)}))},a.prototype.installAll=function(){this.install(["apiRequest","jsError","openPage","pageView","performance","sourceError","blankScreen"])},a.prototype.uninstall=function(){this.options.plugins=[],this._isReady=!1},a}(o);export{S as default};
